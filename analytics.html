<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Ambience">
    <meta name="theme-color" content="#E8E0F0">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.svg">
    <title>Ambience - Analytics</title>
    <style>
        /* ==================== LAVENDER MINIMAL THEME ==================== */
        :root {
            --bg-primary: #F7F4FA;
            --bg-secondary: #FFFFFF;
            --bg-card: #FFFFFF;
            --bg-card-hover: #F0EBF5;
            --bg-card-active: #E8E0F0;
            --text-primary: #4A4458;
            --text-secondary: #8B839C;
            --text-muted: #B8B0C8;
            --accent: #9D8EC7;
            --accent-light: #C4B8DB;
            --accent-dark: #7B6FA8;
            --border: #E8E0F0;
            --shadow: rgba(157, 142, 199, 0.1);
            --success: #7CB8A0;
            --success-light: rgba(124, 184, 160, 0.15);
            --warning: #D4A96A;
            --warning-light: rgba(212, 169, 106, 0.15);
            --danger: #C98B8B;
            --danger-light: rgba(201, 139, 139, 0.15);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            min-height: 100vh;
            color: var(--text-primary);
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            padding: 40px 0 30px;
        }

        h1 {
            font-size: 1.8rem;
            font-weight: 300;
            letter-spacing: 6px;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .subtitle {
            color: var(--text-muted);
            font-size: 0.85rem;
            letter-spacing: 2px;
            font-weight: 300;
        }

        /* Navigation */
        .nav-tabs {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-bottom: 30px;
            padding: 6px;
            background: var(--bg-secondary);
            border-radius: 30px;
            max-width: 320px;
            margin-left: auto;
            margin-right: auto;
            box-shadow: 0 2px 12px var(--shadow);
        }

        .nav-tab {
            flex: 1;
            padding: 10px 20px;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            border-radius: 25px;
            transition: all 0.3s ease;
            text-decoration: none;
            text-align: center;
        }

        .nav-tab:hover {
            color: var(--text-primary);
        }

        .nav-tab.active {
            background: var(--accent);
            color: #fff;
        }

        /* Time Range Selector */
        .time-range {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .time-btn {
            padding: 10px 18px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 22px;
            color: var(--text-secondary);
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
            min-height: 44px;
            font-weight: 500;
        }

        .time-btn:hover {
            background: var(--bg-card-hover);
            color: var(--text-primary);
        }

        .time-btn.active {
            background: var(--accent);
            border-color: var(--accent);
            color: #fff;
        }

        /* KPI Strip */
        .kpi-strip {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .kpi-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 12px var(--shadow);
        }

        .kpi-value {
            font-size: 2rem;
            font-weight: 300;
            margin-bottom: 5px;
            color: var(--text-primary);
        }

        .kpi-label {
            font-size: 0.7rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .kpi-trend {
            font-size: 0.75rem;
            margin-top: 5px;
        }

        .trend-up { color: var(--success); }
        .trend-down { color: var(--danger); }
        .trend-neutral { color: var(--text-muted); }

        /* Chart Container */
        .chart-section {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 2px 12px var(--shadow);
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .chart-title {
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .chart-toggle {
            display: flex;
            gap: 5px;
        }

        .toggle-btn {
            padding: 8px 12px;
            background: transparent;
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-secondary);
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
            min-height: 36px;
            font-weight: 500;
        }

        .toggle-btn:hover {
            background: var(--bg-card-hover);
            color: var(--text-primary);
        }

        .toggle-btn.active {
            background: var(--accent);
            border-color: var(--accent);
            color: #fff;
        }

        /* SVG Chart */
        .chart-container {
            width: 100%;
            height: 250px;
            position: relative;
        }

        .chart-svg {
            width: 100%;
            height: 100%;
        }

        .chart-line {
            fill: none;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
        }

        .chart-area {
            opacity: 0.1;
        }

        .chart-dot {
            cursor: pointer;
        }

        .chart-grid-line {
            stroke: var(--border);
            stroke-width: 1;
        }

        .chart-axis-label {
            fill: var(--text-muted);
            font-size: 10px;
        }

        .tooltip {
            position: absolute;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 10px 15px;
            font-size: 0.85rem;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 100;
            box-shadow: 0 4px 16px var(--shadow);
            color: var(--text-primary);
        }

        .tooltip.visible {
            opacity: 1;
        }

        /* Status Distribution */
        .status-bars {
            display: flex;
            height: 30px;
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .status-bar {
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-size: 0.8rem;
            font-weight: 500;
            transition: width 0.3s ease;
        }

        .status-bar.green {
            background: var(--success);
        }
        .status-bar.amber {
            background: repeating-linear-gradient(
                45deg,
                var(--warning),
                var(--warning) 10px,
                #c59d5a 10px,
                #c59d5a 20px
            );
            color: #fff;
        }
        .status-bar.red {
            background: repeating-linear-gradient(
                -45deg,
                var(--danger),
                var(--danger) 10px,
                #b57777 10px,
                #b57777 20px
            );
        }

        .status-legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .legend-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        .legend-dot.green { background: var(--success); }
        .legend-dot.amber { background: var(--warning); }
        .legend-dot.red { background: var(--danger); }

        /* History Table */
        .history-section {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 2px 12px var(--shadow);
        }

        .history-section h3 {
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 20px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .history-table {
            width: 100%;
            border-collapse: collapse;
        }

        .history-table th {
            text-align: left;
            padding: 12px 10px;
            border-bottom: 1px solid var(--border);
            color: var(--text-muted);
            font-weight: 500;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .history-table td {
            padding: 12px 10px;
            border-bottom: 1px solid var(--border);
            font-size: 0.85rem;
            color: var(--text-primary);
        }

        .status-badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.7rem;
            text-transform: uppercase;
            font-weight: 500;
        }

        .status-badge.green { background: var(--success-light); color: var(--success); }
        .status-badge.green::before { content: '✓ '; }
        .status-badge.amber { background: var(--warning-light); color: var(--warning); }
        .status-badge.amber::before { content: '– '; }
        .status-badge.red { background: var(--danger-light); color: var(--danger); }
        .status-badge.red::before { content: '! '; }

        /* Export Section */
        .export-section {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 2px 12px var(--shadow);
        }

        .export-section h3 {
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .export-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .export-btn {
            padding: 12px 24px;
            background: var(--bg-card-hover);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text-secondary);
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            min-height: 44px;
        }

        .export-btn:hover {
            background: var(--accent);
            border-color: var(--accent);
            color: #fff;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-muted);
        }

        .empty-state h3 {
            margin-bottom: 10px;
            color: var(--text-secondary);
        }

        /* Responsive */
        @media (max-width: 600px) {
            h1 { font-size: 1.8rem; }
            .kpi-strip { grid-template-columns: repeat(2, 1fr); }
            .time-range { gap: 8px; }
            .time-btn { padding: 10px 14px; font-size: 0.85rem; }
            .history-table { font-size: 0.8rem; }
            .chart-toggle { flex-wrap: wrap; gap: 8px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>AMBIENCE</h1>
            <p class="subtitle">Regulate. Reflect. Restore.</p>
        </header>

        <nav class="nav-tabs">
            <a href="noisli.html" class="nav-tab">Sounds</a>
            <a href="scorecard.html" class="nav-tab">Scorecard</a>
            <a href="analytics.html" class="nav-tab active">Analytics</a>
        </nav>

        <!-- Time Range Selector -->
        <div class="time-range">
            <button class="time-btn" data-days="7" onclick="setTimeRange(7)">7 Days</button>
            <button class="time-btn active" data-days="14" onclick="setTimeRange(14)">14 Days</button>
            <button class="time-btn" data-days="28" onclick="setTimeRange(28)">28 Days</button>
            <button class="time-btn" data-days="90" onclick="setTimeRange(90)">90 Days</button>
            <button class="time-btn" data-days="180" onclick="setTimeRange(180)">180 Days</button>
            <button class="time-btn" data-days="365" onclick="setTimeRange(365)">1 Year</button>
        </div>

        <!-- KPI Strip -->
        <div class="kpi-strip">
            <div class="kpi-card">
                <div class="kpi-value" id="kpiCheckinRate">--%</div>
                <div class="kpi-label">Check-in Rate</div>
                <div class="kpi-trend" id="kpiCheckinTrend"></div>
            </div>
            <div class="kpi-card">
                <div class="kpi-value" id="kpiAvgScore">--</div>
                <div class="kpi-label">Avg Score</div>
                <div class="kpi-trend" id="kpiScoreTrend"></div>
            </div>
            <div class="kpi-card">
                <div class="kpi-value" id="kpiGreenCount">--</div>
                <div class="kpi-label">Green Days</div>
                <div class="kpi-trend" id="kpiGreenTrend"></div>
            </div>
            <div class="kpi-card">
                <div class="kpi-value" id="kpiGreenRate">--%</div>
                <div class="kpi-label">Green Rate</div>
                <div class="kpi-trend" id="kpiGreenRateTrend"></div>
            </div>
        </div>

        <!-- Score Chart -->
        <div class="chart-section">
            <div class="chart-header">
                <span class="chart-title">Daily Average Score</span>
                <div class="chart-toggle">
                    <button class="toggle-btn active" onclick="toggleSmoothing(false)">Raw</button>
                    <button class="toggle-btn" onclick="toggleSmoothing(true)">Smoothed</button>
                </div>
            </div>
            <div class="chart-container" id="scoreChartContainer">
                <svg class="chart-svg" id="scoreChart"></svg>
                <div class="tooltip" id="scoreTooltip"></div>
            </div>
        </div>

        <!-- Dimensions Chart -->
        <div class="chart-section">
            <div class="chart-header">
                <span class="chart-title">Dimensions Over Time</span>
                <div class="chart-toggle">
                    <button class="toggle-btn active" data-dim="all" onclick="setDimensionView('all')">All</button>
                    <button class="toggle-btn" data-dim="tone" onclick="setDimensionView('tone')">Tone</button>
                    <button class="toggle-btn" data-dim="load" onclick="setDimensionView('load')">Load</button>
                    <button class="toggle-btn" data-dim="energy" onclick="setDimensionView('energy')">Energy</button>
                    <button class="toggle-btn" data-dim="reactivity" onclick="setDimensionView('reactivity')">React</button>
                </div>
            </div>
            <div class="chart-container" id="dimChartContainer">
                <svg class="chart-svg" id="dimChart"></svg>
                <div class="tooltip" id="dimTooltip"></div>
            </div>
        </div>

        <!-- Status Distribution -->
        <div class="chart-section">
            <div class="chart-header">
                <span class="chart-title">Status Distribution</span>
            </div>
            <div class="status-bars" id="statusBars">
                <div class="status-bar green" id="greenBar" style="width: 33%">33%</div>
                <div class="status-bar amber" id="amberBar" style="width: 34%">34%</div>
                <div class="status-bar red" id="redBar" style="width: 33%">33%</div>
            </div>
            <div class="status-legend">
                <div class="legend-item"><div class="legend-dot green"></div> ✓ Green</div>
                <div class="legend-item"><div class="legend-dot amber"></div> – Amber</div>
                <div class="legend-item"><div class="legend-dot red"></div> ! Red</div>
            </div>
        </div>

        <!-- History -->
        <div class="history-section">
            <h3>Recent Entries</h3>
            <table class="history-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Score</th>
                        <th>Status</th>
                        <th>Tone</th>
                        <th>Load</th>
                        <th>Energy</th>
                        <th>React</th>
                    </tr>
                </thead>
                <tbody id="historyBody">
                    <!-- Generated by JS -->
                </tbody>
            </table>
        </div>

        <!-- Export -->
        <div class="export-section">
            <h3>Export Data</h3>
            <div class="export-buttons">
                <button class="export-btn" onclick="exportCSV()">Download CSV</button>
                <button class="export-btn" onclick="exportJSON()">Download JSON</button>
            </div>
        </div>
    </div>

    <script>
        // ==================== DATA ====================
        const STORAGE_KEY = 'ambienceScorecard';
        let currentDays = 14;
        let smoothing = false;
        let dimensionView = 'all';

        function getData() {
            const data = localStorage.getItem(STORAGE_KEY);
            return data ? JSON.parse(data) : { entries: {}, reviews: {} };
        }

        function getEntriesInRange(days) {
            const data = getData();
            const cutoff = new Date();
            cutoff.setDate(cutoff.getDate() - days);

            return Object.values(data.entries)
                .filter(e => new Date(e.date) >= cutoff)
                .sort((a, b) => new Date(a.date) - new Date(b.date));
        }

        // ==================== KPIs ====================
        function updateKPIs() {
            const entries = getEntriesInRange(currentDays);
            const prevEntries = getEntriesInRange(currentDays * 2)
                .filter(e => new Date(e.date) < new Date(Date.now() - currentDays * 86400000));

            // Check-in rate
            const checkinRate = Math.round((entries.length / currentDays) * 100);
            document.getElementById('kpiCheckinRate').textContent = checkinRate + '%';

            // Average score
            if (entries.length > 0) {
                const avgScore = entries.reduce((sum, e) => sum + e.average, 0) / entries.length;
                document.getElementById('kpiAvgScore').textContent = avgScore.toFixed(1);

                // Previous period comparison
                if (prevEntries.length > 0) {
                    const prevAvg = prevEntries.reduce((sum, e) => sum + e.average, 0) / prevEntries.length;
                    const diff = avgScore - prevAvg;
                    const trendEl = document.getElementById('kpiScoreTrend');
                    if (diff > 0.1) {
                        trendEl.className = 'kpi-trend trend-up';
                        trendEl.textContent = '+' + diff.toFixed(1) + ' vs prev';
                    } else if (diff < -0.1) {
                        trendEl.className = 'kpi-trend trend-down';
                        trendEl.textContent = diff.toFixed(1) + ' vs prev';
                    } else {
                        trendEl.className = 'kpi-trend trend-neutral';
                        trendEl.textContent = 'No change';
                    }
                }
            }

            // Green count
            const greenCount = entries.filter(e => e.status === 'green').length;
            document.getElementById('kpiGreenCount').textContent = greenCount;

            // Green rate
            if (entries.length > 0) {
                const greenRate = Math.round((greenCount / entries.length) * 100);
                document.getElementById('kpiGreenRate').textContent = greenRate + '%';
            }
        }

        // ==================== CHARTS ====================
        const CHART_COLORS = {
            score: '#7CB8A0',
            tone: '#9D8EC7',
            load: '#7B9CC7',
            energy: '#D4A96A',
            reactivity: '#C98B8B'
        };

        function drawScoreChart() {
            const entries = getEntriesInRange(currentDays);
            const svg = document.getElementById('scoreChart');
            const container = document.getElementById('scoreChartContainer');

            if (entries.length === 0) {
                svg.innerHTML = '<text x="50%" y="50%" text-anchor="middle" fill="#666">No data for this period</text>';
                return;
            }

            const width = container.clientWidth;
            const height = 250;
            const padding = { top: 20, right: 20, bottom: 30, left: 40 };

            const chartWidth = width - padding.left - padding.right;
            const chartHeight = height - padding.top - padding.bottom;

            let data = entries.map(e => ({ date: e.date, value: e.average }));

            // Apply smoothing if enabled
            if (smoothing && data.length > 2) {
                data = data.map((d, i) => {
                    if (i === 0 || i === data.length - 1) return d;
                    const avg = (data[i-1].value + d.value + data[i+1].value) / 3;
                    return { ...d, value: avg };
                });
            }

            const xScale = (i) => padding.left + (i / (data.length - 1 || 1)) * chartWidth;
            const yScale = (v) => padding.top + chartHeight - ((v - 1) / 4) * chartHeight;

            // Build SVG
            let svgContent = `
                <defs>
                    <linearGradient id="scoreGradient" x1="0" y1="0" x2="0" y2="1">
                        <stop offset="0%" stop-color="${CHART_COLORS.score}" stop-opacity="0.3"/>
                        <stop offset="100%" stop-color="${CHART_COLORS.score}" stop-opacity="0"/>
                    </linearGradient>
                </defs>
            `;

            // Grid lines
            for (let i = 1; i <= 5; i++) {
                const y = yScale(i);
                svgContent += `<line class="chart-grid-line" x1="${padding.left}" y1="${y}" x2="${width - padding.right}" y2="${y}"/>`;
                svgContent += `<text class="chart-axis-label" x="${padding.left - 10}" y="${y + 4}" text-anchor="end">${i}</text>`;
            }

            // Area
            let areaPath = `M ${xScale(0)} ${yScale(data[0].value)}`;
            data.forEach((d, i) => {
                if (i > 0) areaPath += ` L ${xScale(i)} ${yScale(d.value)}`;
            });
            areaPath += ` L ${xScale(data.length - 1)} ${height - padding.bottom} L ${xScale(0)} ${height - padding.bottom} Z`;
            svgContent += `<path class="chart-area" d="${areaPath}" fill="url(#scoreGradient)"/>`;

            // Line
            let linePath = `M ${xScale(0)} ${yScale(data[0].value)}`;
            data.forEach((d, i) => {
                if (i > 0) linePath += ` L ${xScale(i)} ${yScale(d.value)}`;
            });
            svgContent += `<path class="chart-line" d="${linePath}" stroke="${CHART_COLORS.score}"/>`;

            // Dots
            data.forEach((d, i) => {
                svgContent += `<circle class="chart-dot" cx="${xScale(i)}" cy="${yScale(d.value)}" r="4" fill="${CHART_COLORS.score}"
                    onmouseover="showTooltip(event, 'score', '${d.date}', ${d.value.toFixed(2)})"
                    onmouseout="hideTooltip('score')"/>`;
            });

            // X-axis labels (show every few)
            const labelInterval = Math.ceil(data.length / 6);
            data.forEach((d, i) => {
                if (i % labelInterval === 0 || i === data.length - 1) {
                    const dateLabel = new Date(d.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                    svgContent += `<text class="chart-axis-label" x="${xScale(i)}" y="${height - 10}" text-anchor="middle">${dateLabel}</text>`;
                }
            });

            svg.innerHTML = svgContent;
        }

        function drawDimensionsChart() {
            const entries = getEntriesInRange(currentDays);
            const svg = document.getElementById('dimChart');
            const container = document.getElementById('dimChartContainer');

            if (entries.length === 0) {
                svg.innerHTML = '<text x="50%" y="50%" text-anchor="middle" fill="#666">No data for this period</text>';
                return;
            }

            const width = container.clientWidth;
            const height = 250;
            const padding = { top: 20, right: 20, bottom: 30, left: 40 };

            const chartWidth = width - padding.left - padding.right;
            const chartHeight = height - padding.top - padding.bottom;

            const xScale = (i) => padding.left + (i / (entries.length - 1 || 1)) * chartWidth;
            const yScale = (v) => padding.top + chartHeight - ((v - 1) / 4) * chartHeight;

            let svgContent = '';

            // Grid lines
            for (let i = 1; i <= 5; i++) {
                const y = yScale(i);
                svgContent += `<line class="chart-grid-line" x1="${padding.left}" y1="${y}" x2="${width - padding.right}" y2="${y}"/>`;
                svgContent += `<text class="chart-axis-label" x="${padding.left - 10}" y="${y + 4}" text-anchor="end">${i}</text>`;
            }

            const dimensions = dimensionView === 'all'
                ? ['tone', 'load', 'energy', 'reactivity']
                : [dimensionView];

            dimensions.forEach(dim => {
                let path = '';
                entries.forEach((e, i) => {
                    const x = xScale(i);
                    const y = yScale(e[dim]);
                    if (i === 0) path = `M ${x} ${y}`;
                    else path += ` L ${x} ${y}`;
                });
                svgContent += `<path class="chart-line" d="${path}" stroke="${CHART_COLORS[dim]}" opacity="${dimensions.length > 1 ? 0.7 : 1}"/>`;
            });

            // X-axis labels
            const labelInterval = Math.ceil(entries.length / 6);
            entries.forEach((e, i) => {
                if (i % labelInterval === 0 || i === entries.length - 1) {
                    const dateLabel = new Date(e.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                    svgContent += `<text class="chart-axis-label" x="${xScale(i)}" y="${height - 10}" text-anchor="middle">${dateLabel}</text>`;
                }
            });

            svg.innerHTML = svgContent;
        }

        function updateStatusBars() {
            const entries = getEntriesInRange(currentDays);
            if (entries.length === 0) return;

            const green = entries.filter(e => e.status === 'green').length;
            const amber = entries.filter(e => e.status === 'amber').length;
            const red = entries.filter(e => e.status === 'red').length;
            const total = entries.length;

            const greenPct = Math.round((green / total) * 100);
            const amberPct = Math.round((amber / total) * 100);
            const redPct = 100 - greenPct - amberPct;

            document.getElementById('greenBar').style.width = greenPct + '%';
            document.getElementById('greenBar').textContent = greenPct > 5 ? greenPct + '%' : '';
            document.getElementById('amberBar').style.width = amberPct + '%';
            document.getElementById('amberBar').textContent = amberPct > 5 ? amberPct + '%' : '';
            document.getElementById('redBar').style.width = redPct + '%';
            document.getElementById('redBar').textContent = redPct > 5 ? redPct + '%' : '';
        }

        // ==================== TOOLTIPS ====================
        function showTooltip(event, type, date, value) {
            const tooltip = document.getElementById(type + 'Tooltip');
            const formattedDate = new Date(date).toLocaleDateString('en-US', {
                weekday: 'short', month: 'short', day: 'numeric'
            });
            tooltip.innerHTML = `<strong>${formattedDate}</strong><br>Score: ${value}`;
            tooltip.style.left = (event.offsetX + 10) + 'px';
            tooltip.style.top = (event.offsetY - 40) + 'px';
            tooltip.classList.add('visible');
        }

        function hideTooltip(type) {
            document.getElementById(type + 'Tooltip').classList.remove('visible');
        }

        // ==================== HISTORY TABLE ====================
        function updateHistory() {
            const entries = getEntriesInRange(currentDays).reverse();
            const tbody = document.getElementById('historyBody');

            if (entries.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #666; padding: 30px;">No entries in this period</td></tr>';
                return;
            }

            tbody.innerHTML = entries.slice(0, 20).map(e => {
                const date = new Date(e.date).toLocaleDateString('en-US', {
                    month: 'short', day: 'numeric'
                });
                return `
                    <tr>
                        <td>${date}</td>
                        <td>${e.average.toFixed(1)}</td>
                        <td><span class="status-badge ${e.status}">${e.status}</span></td>
                        <td>${e.tone}</td>
                        <td>${e.load}</td>
                        <td>${e.energy}</td>
                        <td>${e.reactivity}</td>
                    </tr>
                `;
            }).join('');
        }

        // ==================== CONTROLS ====================
        function setTimeRange(days) {
            currentDays = days;
            document.querySelectorAll('.time-btn').forEach(btn => {
                btn.classList.toggle('active', parseInt(btn.dataset.days) === days);
            });
            updateAll();
        }

        function toggleSmoothing(enabled) {
            smoothing = enabled;
            document.querySelectorAll('.chart-section:first-of-type .toggle-btn').forEach((btn, i) => {
                btn.classList.toggle('active', (i === 0 && !enabled) || (i === 1 && enabled));
            });
            drawScoreChart();
        }

        function setDimensionView(view) {
            dimensionView = view;
            document.querySelectorAll('[data-dim]').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.dim === view);
            });
            drawDimensionsChart();
        }

        // ==================== EXPORT ====================
        function exportCSV() {
            const data = getData();
            const entries = Object.values(data.entries).sort((a, b) =>
                new Date(a.date) - new Date(b.date)
            );

            if (entries.length === 0) {
                alert('No data to export');
                return;
            }

            let csv = 'Date,Tone,Load,Energy,Reactivity,Average,Status,Note\n';
            entries.forEach(e => {
                const note = (e.note || '').replace(/"/g, '""');
                csv += `${e.date},${e.tone},${e.load},${e.energy},${e.reactivity},${e.average},${e.status},"${note}"\n`;
            });

            downloadFile(csv, 'calm-scorecard.csv', 'text/csv');
        }

        function exportJSON() {
            const data = getData();
            if (Object.keys(data.entries).length === 0) {
                alert('No data to export');
                return;
            }
            downloadFile(JSON.stringify(data, null, 2), 'calm-scorecard.json', 'application/json');
        }

        function downloadFile(content, filename, type) {
            const blob = new Blob([content], { type });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }

        // ==================== INIT ====================
        function updateAll() {
            updateKPIs();
            drawScoreChart();
            drawDimensionsChart();
            updateStatusBars();
            updateHistory();
        }

        window.addEventListener('resize', () => {
            drawScoreChart();
            drawDimensionsChart();
        });

        document.addEventListener('DOMContentLoaded', () => {
            updateAll();

            // Register service worker for PWA
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('sw.js')
                    .then(reg => console.log('Service Worker registered'))
                    .catch(err => console.log('Service Worker registration failed:', err));
            }
        });
    </script>
</body>
</html>
